name: iOS Build & Submit (EAS)

on:
  workflow_dispatch: {}   # allows manual runs from the Actions tab
  # optionally also run on pushes to main that touch app/eas files:
  # push:
  #   branches: [ main ]
  #   paths:
  #     - app.json
  #     - app.config.ts
  #     - eas.json
  #     - .github/workflows/eas-ios.yml
  #     - package.json
  #     - package-lock.json
  #     - yarn.lock
  #     - pnpm-lock.yaml

jobs:
  ios:
    runs-on: ubuntu-latest
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EXPO_APP_STORE_CONNECT_API_KEY: ${{ secrets.EXPO_APP_STORE_CONNECT_API_KEY }}
      # optional: NODE_VERSION secret; defaults to 20 if unset
      NODE_VERSION: ${{ secrets.NODE_VERSION || '20' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm i; fi

      - name: Set up Expo/EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Show config (quick debug)
        run: |
          echo "Node: $(node -v)"
          which eas && eas --version
          npx --yes expo config --type public --json | jq '.owner, .extra.eas, .ios.bundleIdentifier, .ios.infoPlist'

      - name: Verify Apple key is present and parseable
        run: |
          node -e "const j=process.env.EXPO_APP_STORE_CONNECT_API_KEY; if(!j) process.exit(1); try{const o=JSON.parse(j); if(!o.keyId||!o.issuerId||!o.key) process.exit(1);}catch(e){process.exit(1)}"

      - name: Show Expo config highlights
        run: npx --yes expo config --type public --json | jq '.owner, .extra.eas, .ios.bundleIdentifier, .ios.infoPlist'

      - name: Clear iOS credentials for this bundle id
        run: |
          eas credentials -p ios \
            --bundle-identifier com.obrc.hellovibes \
            --clear-credentials \
            --non-interactive || true

      - name: Build iOS (EAS)
        run: eas build --platform ios --profile production --non-interactive --wait

      - name: Submit to TestFlight
        run: eas submit --platform ios --latest --non-interactive
